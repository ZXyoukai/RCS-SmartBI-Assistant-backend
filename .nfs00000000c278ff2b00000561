#!/usr/bin/env python3
"""
Script para reinstalar e testar dependÃªncias
"""
import subprocess
import sys
import importlib

def install_package(package):
    """Instala um pacote usando pip"""
    try:
        subprocess.check_call([sys.executable, "-m", "pip", "install", package])
        print(f"âœ… {package} instalado com sucesso")
        return True
    except subprocess.CalledProcessError as e:
        print(f"âŒ Erro ao instalar {package}: {e}")
        return False

def test_import(module_name, package_name):
    """Testa se um mÃ³dulo pode ser importado"""
    try:
        importlib.import_module(module_name)
        print(f"âœ… {package_name} funcionando")
        return True
    except ImportError as e:
        print(f"âŒ {package_name} nÃ£o funciona: {e}")
        return False

def main():
    print("ğŸ”§ Reinstalando dependÃªncias do SmartBI Assistant...")
    print()
    
    # Lista de dependÃªncias do requirements.txt
    packages = [
        "pandas",
        "fastapi",
        "uvicorn[standard]", 
        "python-multipart",
        "google-generativeai",
        "python-dotenv",
        "sqlparse",
        "pydantic"
    ]
    
    # Instalar cada pacote
    for package in packages:
        print(f"ğŸ“¦ Instalando {package}...")
        install_package(package)
        print()
    
    print("ğŸ§ª Testando importaÃ§Ãµes...")
    print()
    
    # Testar importaÃ§Ãµes crÃ­ticas
    test_cases = [
        ("pandas", "pandas"),
        ("fastapi", "FastAPI"),
        ("uvicorn", "Uvicorn"),
        ("google.generativeai", "Google Generative AI"),
        ("dotenv", "python-dotenv"),
        ("sqlparse", "sqlparse"),
        ("pydantic", "Pydantic")
    ]
    
    all_working = True
    for module, name in test_cases:
        if not test_import(module, name):
            all_working = False
    
    print()
    if all_working:
        print("ğŸ‰ Todas as dependÃªncias instaladas e funcionando!")
        
        # Teste especÃ­fico do python-dotenv
        print("\nğŸ” Testando python-dotenv especificamente...")
        try:
            from dotenv import load_dotenv
            import os
            
            # Criar arquivo .env de teste
            with open('.env.test', 'w') as f:
                f.write('TEST_VAR=test_value\n')
            
            # Carregar e testar
            load_dotenv('.env.test')
            test_value = os.getenv('TEST_VAR')
            
            if test_value == 'test_value':
                print("âœ… python-dotenv funcionando perfeitamente!")
            else:
                print("âŒ python-dotenv nÃ£o carregou variÃ¡vel corretamente")
            
            # Limpar arquivo de teste
            os.remove('.env.test')
            
        except Exception as e:
            print(f"âŒ Erro ao testar python-dotenv: {e}")
    else:
        print("âŒ Algumas dependÃªncias falharam")
    
    return all_working

if __name__ == "__main__":
    success = main()
    sys.exit(0 if success else 1)
